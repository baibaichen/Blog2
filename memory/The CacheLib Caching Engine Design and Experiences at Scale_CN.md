# The *CacheLib* Caching Engine: Design and Experiences at Scale

**摘要**

Web 服务几乎在系统架构的每一层都依赖于缓存。每个缓存通常都由不同的团队独立实施和维护，并且其功能高度定制化。例如，应用程序数据缓存独立于 CDN 缓存。然而，这种方法忽略了不同缓存系统共同面临的困难挑战，大大增加了部署、维护和扩展每个缓存所需的总体工作。

本文提出了另一种开发缓存的方法，已在 Facebook 成功应用，它从原本不相关的缓存系统中提取了一组核心的通用需求和功能。*CacheLib* 是一种通用缓存引擎，基于 Facebook 的一系列缓存使用经验而设计，简化了缓存的开发和维护。于 2017 年首次在 Facebook 部署，目前支持 70 多项服务，包括 CDN、存储和应用程序数据缓存。本文描述了我们在从独立的、专门的缓存过渡到广泛采用 CacheLib 的过程中的经验。我们将解释 Facebook 的生产工作负载和用例的特征，**==如何驱动了重要的设计决策==**。我们描述了 Facebook 的缓存是如何随着时间的推移而演变的，包括部署 CacheLib 所带来的显着好处。我们还讨论了我们的经验对未来缓存设计和研究的影响。

## 1 简介

大型 Web 服务依靠缓存系统来实现高性能和高效率。例如，在 Facebook，CDN 缓存服务 70% 的 Web 请求，将延迟降低了一个数量级。单台缓存服务器可替代数十台后端数据库服务器，吞吐量提高20%，命中率超过80%。

在 Facebook，各种各样的缓存系统构成了系统架构不可分割的一部分。Facebook 的架构包括 CDN 缓存、应用程序键值缓存、<u>==社交图==</u>缓存和<u>==媒体==</u>缓存（图 1）。缓存在 Amazon [26]、Twitter [42、92]、Reddit [33、89] 和许多其他大型 Web 服务中扮演着类似的角色。

| **图 1**：大型 Web 服务依赖于许多子系统中的缓存来提高系统性能和效率 |
| :----------------------------------------------------------: |
|                     ![](cachelib/F1.png)                     |

**Facebook 的缓存系统**。过去，Facebook 的每个缓存系统都单独实现。例如，Facebook 单独设计了 CDN 缓存 [86]、键值缓存 [72]、社交图缓存 [17]、存储缓存 [71]、数据库缓存 [2] 等。人们相信，高度专业化的系统中需要高度专业化的缓存，以便实现复杂的一致性协议、利用自定义数据结构，并针对所需的硬件平台进行优化。

尽管这些缓存系统服务于不同的工作负载并需要不同的功能，但它们**==共享许多重要的工程和部署挑战==**（第 2 节）。所有这些系统每秒处理数百万个查询，缓存工作集大到需要同时使用闪存和 DRAM 进行缓存，**并且必须容忍由于应用程序更新而导致的频繁重启**，这在 Facebook 生产环境中很常见。随着 Facebook 缓存系统数量的增加，为每个系统维护单独的缓存实现变得难以为继。通过反复解决相同的硬工程挑战，团队重复彼此的工作，并产生冗余的代码。此外，单独维护的缓存系统享受不了**其他缓存系统性能优化带来的效率收益**。

因此，Facebook 面临着通用性和定制化之间的权衡。一个更通用的缓存解决方案可能会失去一些针对个别系统的特定领域的优化，但它可以减少开发成本，并提高系统之间的协同效率。为了平衡这种权衡，出现了通用缓存引擎 CacheLib。

**本文介绍了 Facebook 的可扩展缓存部署解决方案：CacheLib**。CacheLib 是一个 C++ 库，提供了一个通用的缓存功能核心，包括缓存索引的高效实现、逐出策略以及 DRAM 和闪存缓存的稳定性优化。CacheLib 通过一个简单的、线程安全的 API 公开其特性，允许程序员轻松构建和定制可扩展的、高度并发的缓存。CacheLib 既用于构建独立的缓存系统，**也用于向应用程序添加进程内缓存**。Facebook 的 CDN、社交图缓存、应用程序**旁路缓存**和块存储系统都使用使用 CacheLib 构建和定制的缓存。

自 2017 年以来，CacheLib 已投入生产，目前为 70 多种不同的服务提供支持。图 2 显示了 CacheLib 在此期间的增长情况。最初，CacheLib 取代了现有缓存，但自 2018 年年中以来，它促进了整个 Facebook 缓存的爆炸式增长，从而显着降低了后端负载。

| **图 2**：随着时间的推移，使用 CacheLib 构建的 Facebook 服务的数量。例如，其中一项服务是 Facebook 的键值缓存系统。最初的增长是由于现有系统的迁移，但最近，许多新系统都是使用 CacheLib 构建 |
| :----------------------------------------------------------: |
|                     ![](cachelib/F2.png)                     |

### 1.1 Lessons Learned from CacheLib

要开发一个有效的通用缓存框架，不仅需要了解 Facebook 中常见的缓存场景，还需要了解未来部署缓存的更普遍趋势。本节描述了一些场景，在这些场景中，缓存的**==传统智慧==**与我们在Facebook 生产环境中的经验并不匹配。

**专用缓存系统可以而且应该使用通用缓存引擎构建**。 在 Facebook，CacheLib 已经取代了几个主要服务中现有的专用缓存，并促使许多新应用程序采用缓存。

CacheLib 提供比任何单一的专用缓存系统更广泛的功能集。 拥有共同的核心功能可以节省数万行冗余代码，提高系统稳定性，并使开发人员可以轻松部署和调整新的缓存。 此外，CacheLib 还充当优化和最佳实践的聚合点。 因此，基于 CacheLib 构建的系统在单个生产服务器上实现了每秒一百万个请求的峰值吞吐量，命中率在 60% 到 90% 之间。 为了实现这种性能，每个缓存系统都会自定义其缓存以使用其所需的 CacheLib 功能子集。 为了容纳尽可能多的系统，CacheLib 的功能集随着时间的推移而增长。 因此，曾经证明构建专用缓存系统合理的功能现在可用于任何基于 CacheLib 的系统。

CacheLib提供了比任何一个专用缓存系统更广泛的特性集。拥有共同的功能核心可以节省数万行冗余代码，提高系统稳定性，并使开发人员更容易部署和调优新缓存。此外，CacheLib还充当了优化和最佳实践的聚合点。因此，在CacheLib上构建的系统在单个生产服务器上实现了每秒100万个请求的峰值吞吐量，命中率在60到90%之间。为了实现这种性能，每个缓存系统都会定制自己的缓存，以使用所需的CacheLib特性子集。为了容纳尽可能多的系统，CacheLib的特性集随着时间的推移而不断增长。因此，曾经用于构建专用缓存系统的特性现在可以用于任何基于cachelib的系统。

CacheLib提供了比任何单个专用缓存系统都更广泛的功能集。拥有一个共同的核心功能可以节省数万行冗余代码，提高系统稳定性，并使开发人员能够轻松部署和调整新的缓存。此外，CacheLib还可以作为优化和最佳实践的聚合点。因此，基于CacheLib构建的系统在单个生产服务器上实现了每秒一百万个请求的峰值吞吐量，命中率在60%到90%之间。为了实现这一性能，每个缓存系统都会自定义其缓存，以使用CacheLib功能的所需子集。为了适应尽可能多的系统，CacheLib的功能集随着时间的推移而不断增长。因此，曾经证明构建专用缓存系统是合理的功能，现在可以用于任何基于CacheLib的系统。



