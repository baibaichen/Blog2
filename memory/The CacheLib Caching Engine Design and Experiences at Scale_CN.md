# The *CacheLib* Caching Engine: Design and Experiences at Scale

**摘要**

Web 服务几乎在系统架构的每一层都依赖于缓存。每个缓存通常都由不同的团队独立实施和维护，并且其功能高度定制化。例如，应用程序数据缓存独立于 CDN 缓存。然而，这种方法忽略了不同缓存系统共同面临的困难挑战，大大增加了部署、维护和扩展每个缓存所需的总体工作。

本文提出了另一种开发缓存的方法，已在 Facebook 成功应用，它从原本不相关的缓存系统中提取了一组核心的通用需求和功能。*CacheLib* 是一种通用缓存引擎，基于 Facebook 的一系列缓存使用经验而设计，简化了缓存的开发和维护。于 2017 年首次在 Facebook 部署，目前支持 70 多项服务，包括 CDN、存储和应用程序数据缓存。本文描述了我们在从独立的、专门的缓存过渡到广泛采用 CacheLib 的过程中的经验。我们将解释 Facebook 的生产工作负载和用例的特征，**==如何驱动了重要的设计决策==**。我们描述了 Facebook 的缓存是如何随着时间的推移而演变的，包括部署 CacheLib 所带来的显着好处。我们还讨论了我们的经验对未来缓存设计和研究的影响。

## 1 简介

大型 Web 服务依靠缓存系统来实现高性能和高效率。例如，在 Facebook，CDN 缓存服务 70% 的 Web 请求，将延迟降低了一个数量级。单台缓存服务器可替代数十台后端数据库服务器，吞吐量提高20%，命中率超过80%。

在 Facebook，各种各样的缓存系统构成了系统架构不可分割的一部分。Facebook 的架构包括 CDN 缓存、应用程序键值缓存、<u>==社交图==</u>缓存和<u>==媒体==</u>缓存（图 1）。缓存在 Amazon [26]、Twitter [42、92]、Reddit [33、89] 和许多其他大型 Web 服务中扮演着类似的角色。

| **图 1**：大型 Web 服务依赖于许多子系统中的缓存来提高系统性能和效率 |
| :----------------------------------------------------------: |
|                     ![](cachelib/F1.png)                     |

**Facebook 的缓存系统**。过去，Facebook 的每个缓存系统都单独实现。例如，Facebook 单独设计了 CDN 缓存 [86]、键值缓存 [72]、社交图缓存 [17]、存储缓存 [71]、数据库缓存 [2] 等。人们相信，高度专业化的系统中需要高度专业化的缓存，以便实现复杂的一致性协议、利用自定义数据结构，并针对所需的硬件平台进行优化。

尽管这些缓存系统服务于不同的工作负载并需要不同的功能，但它们**==共享许多重要的工程和部署挑战==**（第 2 节）。所有这些系统每秒处理数百万个查询，缓存工作集大到需要同时使用闪存和 DRAM 进行缓存，**并且必须容忍由于应用程序更新而导致的频繁重启**，这在 Facebook 生产环境中很常见。随着 Facebook 缓存系统数量的增加，为每个系统维护单独的缓存实现变得难以为继。通过反复解决相同的硬工程挑战，团队重复彼此的工作，并产生冗余的代码。此外，单独维护的缓存系统享受不了**其他缓存系统性能优化带来的效率收益**。

因此，Facebook 面临着通用性和定制化之间的权衡。一个更通用的缓存解决方案可能会失去一些针对个别系统的特定领域的优化，但它可以减少开发成本，并提高系统之间的协同效率。为了平衡这种权衡，出现了通用缓存引擎 CacheLib。

**本文介绍了 Facebook 的可扩展缓存部署解决方案：CacheLib**。CacheLib 是一个 C++ 库，提供了一个通用的缓存功能核心，包括缓存索引的高效实现、逐出策略以及 DRAM 和闪存缓存的稳定性优化。CacheLib 通过一个简单的、线程安全的 API 公开其特性，允许程序员轻松构建和定制可扩展的、高度并发的缓存。CacheLib 既用于构建独立的缓存系统，**也用于向应用程序添加进程内缓存**。Facebook 的 CDN、社交图缓存、应用程序**旁路缓存**和块存储系统都使用使用 CacheLib 构建和定制的缓存。

自 2017 年以来，CacheLib 已投入生产，目前为 70 多种不同的服务提供支持。图 2 显示了 CacheLib 在此期间的增长情况。最初，CacheLib 取代了现有缓存，但自 2018 年年中以来，它促进了整个 Facebook 缓存的爆炸式增长，从而显着降低了后端负载。

| **图 2**：随着时间的推移，使用 CacheLib 构建的 Facebook 服务的数量。例如，其中一项服务是 Facebook 的键值缓存系统。最初的增长是由于现有系统的迁移，但最近，许多新系统都是使用 CacheLib 构建 |
| :----------------------------------------------------------: |
|                     ![](cachelib/F2.png)                     |

### 1.1 Lessons Learned from CacheLib

要开发一个有效的通用缓存框架，不仅需要了解 Facebook 中常见的缓存场景，还需要了解未来部署缓存的更普遍趋势。本节描述了一些场景，在这些场景中，缓存的**==传统智慧==**与我们在Facebook 生产环境中的经验并不匹配。

**专用缓存系统可以而且应该使用通用缓存引擎构建**。 在 Facebook，CacheLib 已经取代了几个主要服务中现有的专用缓存，并促使许多新应用程序采用缓存。CacheLib 提供比任何单一的专用缓存系统更广泛的功能集。拥有共同的核心功能可以节省数万行冗余代码，提高系统稳定性，开发人员更容易部署和调优新缓存。此外，CacheLib 还充当优化和最佳实践的聚合点。 因此，基于 CacheLib 构建的系统在单个生产服务器上实现了每秒一百万个请求的峰值吞吐量，命中率在 60% 到 90% 之间。为了实现这种性能，每个缓存系统都会定制自己的缓存，以使用其所需的 CacheLib 功能子集。为了容纳尽可能多的系统，CacheLib 的功能集随着时间的推移而增长。因此，曾经用于构建专用缓存系统的特性，现在可用于任何基于 CacheLib 的系统。

生产环境需要大规模缓存。先前对生产系统工作负载的研究 [4、5] 没有分享 Key 的流行分布。因此，流行的基准测试工具 [24、59] 和学术论文 [19、36、41、49、53、65、66、68、74、90、94] 假设形状参数 **α ≈ .9** 的 **==Zipf 流行模型==**^注1^。由此得出的结论是，在大多数情况下，基于 DRAM 的高速缓存就足够了。 我们提供了强有力的证据，证明先前的模型对生产工作负载的可缓存性过于乐观。

> ^注1^[互联网中对象访问频率的91分布](https://blog.openacid.com/tech/zipf/)

由于 Facebook 的工作负载比通常假设的更难缓存，因此 Facebook 的缓存需要大量容量才能达到可接受的命中率。Facebook 的缓存系统通常由大型分布式系统组成，其中每个节点都有数百 GB 的缓存容量。 这使得使用闪存进行缓存具有吸引力。**但是，大多数缓存系统历来都以 DRAM 为目标，并且使用闪存无法达到可接受的性能**。

**缓存不是一个已解决的问题**。 自 2017 年首次部署以来，随着新场景和新需求的出现，CacheLib 不断添加功能。这些新功能已被现有 CacheLib 用户和使用 CacheLib 开发的新系统迅速广泛采用，因此 CacheLib 共享的核心功能随着应用程序的发展而增长。

### 1.2 Bridging the Gap between Research and Production Caching Systems

正如 Facebook 的开发人员在历史上开发了专门的缓存系统一样，我们注意到缓存文献通常针对专门的缓存系统。 这对行业采用研究社区的想法构成了障碍，因为专业研究系统所做的假设很少与生产环境的现实完全一致。我们希望 CacheLib 能够为探索 Facebook 之外的新想法提供一个平台，从而减少这些障碍。CacheLib 和精选的 Facebook 工作负载将开源^1^。

> 更多信息，请移至 [www.cachelib.org](http://www.cachelib.org/)

## 2 动机：缓存场景

大型 Web 服务依赖于数百种专门服务，其中包含各种缓存场景。 本节抽取了 Facebook 的六个生产系统，描述其缓存需求。

**分层和地理分布式缓存**。Facebook 的 CDN 侧重于为来自用户附近服务器的 HTTP 请求服务，返回静态媒体对象（例如照片、音频和视频块）。具体来说，部署在 Facebook 网络之外的 CDN 服务器的一个目标是减少通过广域网发送的字节数（字节未命中率）。 Facebook 的数据中心内也有 CDN 服务器； 他们的目标是减少后端服务和存储的查询数量（对象未命中率）。每个 CDN 服务器都使用本地缓存，包括 DRAM 和闪存。

**应用程序的旁路缓存**。Web 应用程序有广泛的缓存需求。 例如，应用程序必须缓存数据库查询、用户数据和使用统计信息。 为每个应用程序提供专门的缓存服务效率低下且难以维护。 因此，应用程序使用 RPC 访问一组共享缓存服务。 每个缓存服务都包含一个大型分布式缓存系统。

**进程内缓存**。许多应用程序不能容忍远程缓存的 RPC 开销。 CacheLib 使这些应用程序很容易包含与应用程序逻辑**解耦的高性能进程内缓存**。

例如，一些后端应用程序使用 CacheLib 缓存来存储客户端会话信息，用于限制客户端速率。具体来说，这些应用程序会缓存流量计数器，会看到这些计数器非常高的突发请求率，但一旦流量减慢就会被驱逐。 在这种情况下，缓存的延迟和带宽要求使得远程缓存不可行。 相反，应用程序实例化一个 CacheLib 缓存，它提供对缓存流计数器的**零拷贝访问**。

**机器学习模型服务系统**。面向用户的机器学习应用程序受益于多处缓存。首先，模型的输入通常是基于用户与内容的交互方式（例如，喜欢某段内容）。因此缓存内容交互计数器，应用程序可以快速访问<u>生成预测所需的输入</u>（例如，对内容进行排名）。其次，由于基于相同输入重复生成预测的计算成本很高，因此模型预测也会被缓存。

**后端存储缓存**。Facebook 的大型服务器集群使用**普通旋转磁盘**来存储持久数据块。即使在块存储服务器前面有多个缓存层，一些块仍然很受欢迎，足以超过磁盘**标称的 IOPS**。存储服务器使用闪存驱动器来缓存常用块，并保护旋转磁盘免受负载影响。为了支持**字节范围**的请求和追加操作，这些闪存缓存紧密集成在存储系统的技术堆栈中。

**数据库页缓冲区**。 数据结构和小对象存储在各种数据库系统中。 数据库系统使用页面缓存来增加吞吐量并减少访问延迟。 为了支持一致性和事务性操作，页面缓存与数据库逻辑紧密集成。

在 Facebook ，我们发现了数百种不同的服务，它们实现了缓存，或者它们的效率可以从缓存层中获益。这些用例**跨越数据中心堆栈和管理域的所有层**。 缓存研究跨越操作系统 [16,52]、存储系统 [20, 58]、分布式系统 [8, 22, 66]、网络系统 [9, 65]、数据库 [30] 和计算机体系结构 [7, 56] , 91]。

CacheLib 通过提供一个组件**库**来处理这些不同的用例，从而可以轻松地快速构建高性能缓存。在许多情况下，CacheLib 缓存已经取代了 Facebook 高度专业化的缓存系统。 CacheLib 目前用于数十个生产系统，涵盖上述六个示例中的五个。值得注意的是，CacheLib 当前不用作数据库页面缓冲区（请参阅第 6 节）。 因此，虽然 CacheLib 不会取代所有专门的缓存系统，但我们已经看到 Facebook 广泛采用通用缓存引擎。

## 3 Facebook 跨缓存系统的共同挑战
